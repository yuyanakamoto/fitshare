<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>FitShare - 筋トレSNS</title>
    
    <!-- アイコン設定 -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%233B82F6'/><text x='50' y='50' font-size='60' text-anchor='middle' dy='.3em' fill='white'>💪</text></svg>">
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Socket.io Client -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* PWA用のスタイル */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior-y: contain;
        }
        
        /* スクロールバーを非表示 */
        ::-webkit-scrollbar {
            display: none;
        }
        
        /* Lucideアイコン用のスタイル */
        .lucide-icon {
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // 簡易的なLucideアイコンコンポーネント
        const Icon = ({ name, className = "" }) => {
            const icons = {
                dumbbell: "M6.5 6.5L17.5 17.5M6.5 6.5L3 3M6.5 6.5L3 10M17.5 17.5L21 21M17.5 17.5L21 14M3 10V14L7 18L10 21H14L18 17L21 14V10L17 7L14 3H10L7 6L3 10Z",
                plus: "M12 5v14m-7-7h14",
                heart: "M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z",
                "message-circle": "M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z",
                wifi: "M5 12.55a11 11 0 0 1 14.08 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01",
                "wifi-off": "M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01M5 12.55a11 11 0 0 1 14.08 0M1 1l22 22"
            };
            
            return React.createElement('svg', {
                className: `lucide-icon ${className}`,
                xmlns: "http://www.w3.org/2000/svg",
                width: 24,
                height: 24,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: 2,
                strokeLinecap: "round",
                strokeLinejoin: "round"
            }, React.createElement('path', { d: icons[name] || "" }));
        };

        // アイコンコンポーネント
        const Dumbbell = (props) => React.createElement(Icon, { name: "dumbbell", ...props });
        const Plus = (props) => React.createElement(Icon, { name: "plus", ...props });
        const Heart = (props) => React.createElement(Icon, { name: "heart", ...props });
        const MessageCircle = (props) => React.createElement(Icon, { name: "message-circle", ...props });
        const Wifi = (props) => React.createElement(Icon, { name: "wifi", ...props });
        const WifiOff = (props) => React.createElement(Icon, { name: "wifi-off", ...props });

        // メインのReactコンポーネント
        const FitShareApp = () => {
            const [posts, setPosts] = React.useState([]);
            const [socket, setSocket] = React.useState(null);
            const [connected, setConnected] = React.useState(false);
            const [showForm, setShowForm] = React.useState(false);
            const [userName, setUserName] = React.useState(() => {
                return localStorage.getItem('fitShareUserName') || '';
            });
            const [showNamePrompt, setShowNamePrompt] = React.useState(!userName);
            const [tempUserName, setTempUserName] = React.useState('');
            
            const [formData, setFormData] = React.useState({
                exercise: '',
                weight: '',
                sets: '',
                reps: '',
                comment: ''
            });

            // サーバーURLは現在のホストを使用
            const SERVER_URL = window.location.origin;

            React.useEffect(() => {
                // Socket.io接続
                const newSocket = io(SERVER_URL);
                setSocket(newSocket);

                newSocket.on('connect', () => {
                    console.log('サーバーに接続しました');
                    setConnected(true);
                });

                newSocket.on('disconnect', () => {
                    console.log('サーバーから切断されました');
                    setConnected(false);
                });

                // 全投稿を受信
                newSocket.on('allPosts', (allPosts) => {
                    setPosts(allPosts);
                });

                // 新規投稿を受信
                newSocket.on('newPost', (newPost) => {
                    setPosts(prev => [newPost, ...prev]);
                });

                // 投稿の更新を受信（いいねなど）
                newSocket.on('updatePost', (updatedPost) => {
                    setPosts(prev => prev.map(post => 
                        post.id === updatedPost.id ? updatedPost : post
                    ));
                });

                // 初期データ取得
                fetch(`${SERVER_URL}/api/posts`)
                    .then(res => res.json())
                    .then(data => setPosts(data))
                    .catch(err => console.error('投稿の取得に失敗しました:', err));

                return () => {
                    newSocket.close();
                };
            }, []);

            const exercises = [
                'ベンチプレス',
                'スクワット',
                'デッドリフト',
                'ショルダープレス',
                'ラットプルダウン',
                'バーベルカール',
                'レッグプレス',
                'チェストフライ',
                'プルアップ',
                'ディップス',
                'ダンベルフライ',
                'レッグカール',
                'カーフレイズ',
                'アームカール',
                'トライセプスエクステンション'
            ];

            const handleSetUserName = () => {
                if (tempUserName.trim()) {
                    setUserName(tempUserName);
                    localStorage.setItem('fitShareUserName', tempUserName);
                    setShowNamePrompt(false);
                }
            };

            const handleSubmit = async () => {
                if (formData.exercise && formData.weight && formData.sets && formData.reps) {
                    const newPost = {
                        user: userName,
                        avatar: userName.charAt(0),
                        exercise: formData.exercise,
                        weight: parseInt(formData.weight),
                        sets: parseInt(formData.sets),
                        reps: parseInt(formData.reps),
                        comment: formData.comment
                    };

                    try {
                        const response = await fetch(`${SERVER_URL}/api/posts`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(newPost)
                        });

                        if (response.ok) {
                            setFormData({ exercise: '', weight: '', sets: '', reps: '', comment: '' });
                            setShowForm(false);
                        }
                    } catch (error) {
                        console.error('投稿の送信に失敗しました:', error);
                        alert('投稿の送信に失敗しました。もう一度お試しください。');
                    }
                }
            };

            const handleLike = async (postId) => {
                try {
                    await fetch(`${SERVER_URL}/api/posts/${postId}/like`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ userId: userName })
                    });
                } catch (error) {
                    console.error('いいねの送信に失敗しました:', error);
                }
            };

            const formatTimestamp = (timestamp) => {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'たった今';
                if (minutes < 60) return `${minutes}分前`;
                if (hours < 24) return `${hours}時間前`;
                if (days < 7) return `${days}日前`;
                return date.toLocaleDateString('ja-JP');
            };

            // 名前入力プロンプト
            if (showNamePrompt) {
                return React.createElement('div', { className: "min-h-screen bg-blue-600 flex items-center justify-center p-4" },
                    React.createElement('div', { className: "bg-white rounded-lg shadow-xl p-6 w-full max-w-sm" },
                        React.createElement('h2', { className: "text-2xl font-bold mb-4 text-center" }, "ようこそ FitShare へ！"),
                        React.createElement('p', { className: "text-gray-600 mb-4 text-center" }, "まずはお名前を教えてください"),
                        React.createElement('input', {
                            type: "text",
                            value: tempUserName,
                            onChange: (e) => setTempUserName(e.target.value),
                            className: "w-full p-3 border rounded-lg mb-4 text-lg",
                            placeholder: "ニックネーム",
                            maxLength: 10
                        }),
                        React.createElement('button', {
                            onClick: handleSetUserName,
                            className: "w-full bg-blue-600 text-white rounded-lg py-3 text-lg font-semibold"
                        }, "はじめる")
                    )
                );
            }

            // メインのUI
            return React.createElement('div', { className: "min-h-screen bg-gray-100 pb-20" },
                // ヘッダー
                React.createElement('header', { className: "bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-10" },
                    React.createElement('div', { className: "flex items-center justify-between" },
                        React.createElement('div', { className: "flex items-center space-x-2" },
                            React.createElement(Dumbbell, { className: "h-6 w-6" }),
                            React.createElement('h1', { className: "text-xl font-bold" }, "FitShare")
                        ),
                        React.createElement('div', { className: "flex items-center space-x-3" },
                            React.createElement('div', { className: `flex items-center space-x-1 ${connected ? 'text-green-300' : 'text-red-300'}` },
                                connected ? React.createElement(Wifi, { className: "h-4 w-4" }) : React.createElement(WifiOff, { className: "h-4 w-4" }),
                                React.createElement('span', { className: "text-xs" }, connected ? 'オンライン' : 'オフライン')
                            ),
                            React.createElement('div', { className: "text-sm" }, '👤 ', userName)
                        )
                    )
                ),

                React.createElement('main', { className: "px-4 py-4" },
                    // 投稿ボタン
                    React.createElement('button', {
                        onClick: () => setShowForm(!showForm),
                        className: "w-full bg-blue-600 text-white rounded-xl p-4 mb-4 flex items-center justify-center space-x-2 shadow-lg active:scale-95 transition-transform",
                        disabled: !connected
                    },
                        React.createElement(Plus, { className: "h-5 w-5" }),
                        React.createElement('span', { className: "font-semibold" }, "トレーニングを記録")
                    ),

                    // 接続エラーメッセージ
                    !connected && React.createElement('div', { className: "bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg mb-4" },
                        React.createElement('p', { className: "text-sm" }, "サーバーに接続できません。接続を確認してください。")
                    ),

                    // 投稿フォーム
                    showForm && React.createElement('div', { className: "bg-white rounded-xl shadow-lg p-4 mb-4" },
                        React.createElement('h2', { className: "text-lg font-bold mb-3" }, "トレーニング記録"),
                        React.createElement('div', { className: "space-y-3" },
                            React.createElement('div', {},
                                React.createElement('label', { className: "block text-sm font-medium mb-1" }, "種目"),
                                React.createElement('select', {
                                    value: formData.exercise,
                                    onChange: (e) => setFormData({ ...formData, exercise: e.target.value }),
                                    className: "w-full p-3 border rounded-lg text-base",
                                    required: true
                                },
                                    React.createElement('option', { value: "" }, "選択してください"),
                                    exercises.map(ex => React.createElement('option', { key: ex, value: ex }, ex))
                                )
                            ),

                            React.createElement('div', { className: "grid grid-cols-3 gap-2" },
                                React.createElement('div', {},
                                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "重量(kg)"),
                                    React.createElement('input', {
                                        type: "number",
                                        inputMode: "numeric",
                                        value: formData.weight,
                                        onChange: (e) => setFormData({ ...formData, weight: e.target.value }),
                                        className: "w-full p-3 border rounded-lg text-base",
                                        placeholder: "80"
                                    })
                                ),
                                React.createElement('div', {},
                                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "セット"),
                                    React.createElement('input', {
                                        type: "number",
                                        inputMode: "numeric",
                                        value: formData.sets,
                                        onChange: (e) => setFormData({ ...formData, sets: e.target.value }),
                                        className: "w-full p-3 border rounded-lg text-base",
                                        placeholder: "3"
                                    })
                                ),
                                React.createElement('div', {},
                                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "レップ"),
                                    React.createElement('input', {
                                        type: "number",
                                        inputMode: "numeric",
                                        value: formData.reps,
                                        onChange: (e) => setFormData({ ...formData, reps: e.target.value }),
                                        className: "w-full p-3 border rounded-lg text-base",
                                        placeholder: "10"
                                    })
                                )
                            ),

                            React.createElement('div', {},
                                React.createElement('label', { className: "block text-sm font-medium mb-1" }, "コメント"),
                                React.createElement('textarea', {
                                    value: formData.comment,
                                    onChange: (e) => setFormData({ ...formData, comment: e.target.value }),
                                    className: "w-full p-3 border rounded-lg text-base",
                                    rows: "2",
                                    placeholder: "今日の調子など..."
                                })
                            ),

                            React.createElement('div', { className: "flex space-x-2" },
                                React.createElement('button', {
                                    onClick: handleSubmit,
                                    className: "flex-1 bg-blue-600 text-white rounded-lg py-3 font-semibold active:bg-blue-700"
                                }, "投稿"),
                                React.createElement('button', {
                                    onClick: () => setShowForm(false),
                                    className: "flex-1 bg-gray-300 text-gray-700 rounded-lg py-3 font-semibold active:bg-gray-400"
                                }, "キャンセル")
                            )
                        )
                    ),

                    // 投稿一覧
                    React.createElement('div', { className: "space-y-3" },
                        posts.map(post => {
                            const hasLiked = post.likedBy && post.likedBy.includes(userName);
                            
                            return React.createElement('div', { key: post.id || post._id, className: "bg-white rounded-xl shadow-md p-4" },
                                React.createElement('div', { className: "flex items-start space-x-3" },
                                    React.createElement('div', { className: "w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold" },
                                        post.avatar
                                    ),
                                    React.createElement('div', { className: "flex-1" },
                                        React.createElement('div', { className: "flex items-center justify-between mb-2" },
                                            React.createElement('h3', { className: "font-semibold" }, post.user),
                                            React.createElement('span', { className: "text-xs text-gray-500" }, formatTimestamp(post.timestamp))
                                        ),
                                        
                                        React.createElement('div', { className: "bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-3 mb-2" },
                                            React.createElement('div', { className: "flex items-center space-x-2 mb-2" },
                                                React.createElement(Dumbbell, { className: "h-4 w-4 text-blue-600" }),
                                                React.createElement('span', { className: "font-semibold" }, post.exercise)
                                            ),
                                            React.createElement('div', { className: "grid grid-cols-3 gap-2 text-center" },
                                                React.createElement('div', { className: "bg-white rounded-lg p-2" },
                                                    React.createElement('div', { className: "text-xl font-bold text-blue-600" }, post.weight),
                                                    React.createElement('div', { className: "text-xs text-gray-600" }, "kg")
                                                ),
                                                React.createElement('div', { className: "bg-white rounded-lg p-2" },
                                                    React.createElement('div', { className: "text-xl font-bold text-blue-600" }, post.sets),
                                                    React.createElement('div', { className: "text-xs text-gray-600" }, "セット")
                                                ),
                                                React.createElement('div', { className: "bg-white rounded-lg p-2" },
                                                    React.createElement('div', { className: "text-xl font-bold text-blue-600" }, post.reps),
                                                    React.createElement('div', { className: "text-xs text-gray-600" }, "レップ")
                                                )
                                            )
                                        ),

                                        post.comment && React.createElement('p', { className: "text-gray-700 text-sm mb-2" }, post.comment),

                                        React.createElement('div', { className: "flex items-center space-x-4" },
                                            React.createElement('button', {
                                                onClick: () => handleLike(post._id || post.id),
                                                className: "flex items-center space-x-1 text-gray-600 active:text-red-500",
                                                disabled: !connected
                                            },
                                                React.createElement(Heart, { className: `h-5 w-5 ${hasLiked ? 'fill-red-500 text-red-500' : ''}` }),
                                                React.createElement('span', { className: "text-sm" }, post.likes)
                                            ),
                                            React.createElement('div', { className: "flex items-center space-x-1 text-gray-600" },
                                                React.createElement(MessageCircle, { className: "h-5 w-5" }),
                                                React.createElement('span', { className: "text-sm" }, post.comments)
                                            )
                                        )
                                    )
                                )
                            );
                        })
                    )
                )
            );
        };

        // アプリケーションをマウント
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(FitShareApp));
    </script>
</body>
</html>